<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Carta interactiva ‚Äî Galaxia & Reino</title>

<style>
  :root { --accent:#ff6b8a; --gold:#ffd166; }
  body { margin:0; overflow:hidden; font-family: "Segoe UI", system-ui, sans-serif; background:#000; color:white; }
  #uiTop { position:absolute; top:16px; left:0; right:0; text-align:center; z-index:30; pointer-events:none; }
  #title { font-family:'Segoe Script', cursive; font-size:26px; color:var(--gold); text-shadow:0 0 8px #fff; pointer-events:auto; }
  #btns { position:absolute; top:16px; right:16px; z-index:40; display:flex; gap:10px; }
  .smallBtn { pointer-events:auto; background:linear-gradient(45deg,#ffb347,#ff416c); border:none; color:white; padding:8px 12px; border-radius:12px; cursor:pointer; box-shadow:0 6px 18px rgba(255,70,120,0.15); }
  #nextSceneBtn { position: absolute; bottom:30px; right:30px; z-index:40; display:none; }
  /* bubble */
  #bubble { position:fixed; left:28px; bottom:28px; width:64px; height:64px; border-radius:50%; background: radial-gradient(circle at top,#ffd1dc,#ff4f81); box-shadow:0 8px 30px rgba(255,80,160,0.5); cursor:pointer; z-index:45; display:flex; align-items:center; justify-content:center; font-weight:bold; }
  #modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:60; }
  #modalCard { background:linear-gradient(135deg,#ff7eb3,#ff758c); padding:18px; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,0.6); color:#fff; }
  .modalBtn { margin:6px; padding:8px 12px; border-radius:10px; border:none; cursor:pointer; }
  /* messages (when near sun/moon/earth) */
  #messageBox { position:fixed; left:50%; transform:translateX(-50%); bottom:90px; z-index:50; pointer-events:none; font-size:18px; color:#fff; background:rgba(0,0,0,0.45); padding:10px 16px; border-radius:12px; display:none; }
  /* helper for fish button */
  #lakeNext { margin-top:12px; display:inline-block; }
</style>
</head>
<body>

<div id="uiTop"><div id="title">Nuestra galaxia infinita üí´ ‚Äî Escena activa: <span id="sceneLabel">Galaxia</span></div></div>

<div id="btns">
  <button class="smallBtn" id="toGalaxy">Galaxia</button>
  <button class="smallBtn" id="toScene3">Reino (Sol/Luna/Mundo)</button>
</div>

<button id="nextSceneBtn" class="smallBtn">Siguiente ‚ú®</button>

<!-- Burbuja musical -->
<div id="bubble">‚ô™</div>

<!-- Modal musical -->
<div id="modal">
  <div id="modalCard">
    <h3>üéµ Nuestra m√∫sica</h3>
    <div>
      <button class="modalBtn" onclick="playMusic()">‚ñ∂Ô∏è Play</button>
      <button class="modalBtn" onclick="pauseMusic()">‚è∏Ô∏è Pausa</button>
      <button class="modalBtn" onclick="nextTrack()">‚è≠Ô∏è Siguiente</button>
    </div>
    <div style="margin-top:10px;">
      Volumen <input type="range" min="0" max="1" step="0.01" value="0.6" id="volRange" onchange="setVol(this.value)">
    </div>
    <div style="margin-top:10px; text-align:right;">
      <button class="modalBtn" onclick="closeModal()">Cerrar</button>
    </div>
  </div>
</div>

<div id="messageBox"></div>

<!-- canvas ser√° creado por three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

<script>
/* =====================================================
   M√öSICA GLOBAL PERSISTENTE (funciona dentro de SPA)
   Si m√°s adelante migras a m√∫ltiples p√°ginas, convierte app
   a SPA (como aqu√≠) o usa iframe/worker ‚Äî navegar recarga la pesta√±a.
   ===================================================== */
window.playlist = window.playlist || ["musica/musica1.mp3","musica/musica2.mp3"];
window._trackIndex = window._trackIndex ?? 0;

if (!window.bgMusic) {
  window.bgMusic = new Audio(window.playlist[window._trackIndex]);
  window.bgMusic.loop = false;
  window.bgMusic.volume = 0.6;
  window.bgMusic.addEventListener("ended", ()=> {
    window._trackIndex = (window._trackIndex + 1) % window.playlist.length;
    window.bgMusic.src = window.playlist[window._trackIndex];
    window.bgMusic.play();
  });
  // don't auto play until user's first interaction due to browser policies
}

/* modal controls */
const bubble = document.getElementById("bubble");
const modal = document.getElementById("modal");
function openModal(){ modal.style.display = "flex"; }
function closeModal(){ modal.style.display = "none"; }

bubble.onclick = openModal;
function playMusic(){ 
  window.bgMusic.play(); 
}
function pauseMusic(){ window.bgMusic.pause(); }
function nextTrack(){
  window._trackIndex = (window._trackIndex + 1) % window.playlist.length;
  window.bgMusic.src = window.playlist[window._trackIndex];
  window.bgMusic.play();
}
function setVol(v){ window.bgMusic.volume = Number(v); }
document.getElementById("volRange").value = window.bgMusic.volume;

/* Ensure first user interaction starts music if not started */
document.body.addEventListener("pointerdown", ()=> {
  if (window.bgMusic && window.bgMusic.paused) {
    try { window.bgMusic.play(); } catch(e){ /* ignore */ }
  }
}, { once:true });

/* =====================================================
   THREE.JS SETUP (un renderer, cambiamos escenas por montar/desmontar)
   ===================================================== */
let renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
document.body.appendChild(renderer.domElement);

let camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 3000);
camera.position.set(0, 0, 80);

let clock = new THREE.Clock();

let currentScene = null;     // THREE.Scene
let sceneName = "galaxia";   // "galaxia" or "reino"

/* Global simple mouse control for camera rotation */
let mouse = { x:0, y:0 };
window.addEventListener("mousemove", (e)=>{
  mouse.x = (e.clientX / window.innerWidth - 0.5) * 2;
  mouse.y = (e.clientY / window.innerHeight - 0.5) * 2;
});

/* Helper: clear scene */
function disposeScene(sc){
  if(!sc) return;
  sc.traverse(obj=>{
    if(obj.geometry) obj.geometry.dispose();
    if(obj.material){
      if(Array.isArray(obj.material)){
        obj.material.forEach(m=>m.dispose());
      } else {
        obj.material.dispose();
      }
    }
    if(obj.texture) obj.texture.dispose?.();
  });
}

/* =====================================================
   ESCENA 2: GALAXIA (funciones para montar/desmontar)
   ===================================================== */
let galaxy = null;
let galaxyObjects = { stars:null, photos:[] };

function mountGalaxy(){
  sceneName = "galaxia";
  document.getElementById("sceneLabel").innerText = "Galaxia";
  disposeScene(currentScene);
  currentScene = new THREE.Scene();

  // fondo negro
  currentScene.background = new THREE.Color(0x000000);

  // estrellas
  let starGeo = new THREE.BufferGeometry();
  let starCount = 2500;
  let positions = new Float32Array(starCount*3);
  for(let i=0;i<starCount;i++){
    positions[i*3+0] = (Math.random()-0.5)*1200;
    positions[i*3+1] = (Math.random()-0.5)*1200;
    positions[i*3+2] = (Math.random()-0.5)*1200;
  }
  starGeo.setAttribute("position", new THREE.BufferAttribute(positions,3));
  let starMat = new THREE.PointsMaterial({ size:0.8, color:0xffffff });
  galaxyObjects.stars = new THREE.Points(starGeo, starMat);
  currentScene.add(galaxyObjects.stars);

  // fotos (planos)
  const fotoUrls = [
    "fotos/foto1.jpg","fotos/foto2.jpg","fotos/foto3.jpg","img/foto4.jpg"
  ];
  galaxyObjects.photos = [];
  const loader = new THREE.TextureLoader();
  fotoUrls.forEach((u, idx)=>{
    loader.load(u, (tex)=>{
      let mat = new THREE.MeshBasicMaterial({ map:tex, side:THREE.DoubleSide });
      let geo = new THREE.PlaneGeometry(16,12);
      let m = new THREE.Mesh(geo, mat);
      m.position.set((Math.random()-0.5)*240, (Math.random()-0.5)*160, (Math.random()-0.5)*240);
      m.rotation.set(Math.random()*0.3-0.15, Math.random()*Math.PI, 0);
      currentScene.add(m);
      galaxyObjects.photos.push(m);
    }, undefined, ()=>{ /* on error ignore */ });
  });

  // subtle ambient glow via light
  currentScene.add(new THREE.AmbientLight(0x888888,0.6));
}

/* =====================================================
   ESCENA 3: REINO (sol, luna, mundo)
   ===================================================== */
let reinoObjects = { sun:null, moon:null, earth:null, fishGroup:null, lakePlane:null };
let interactionLocked = false; // bloquea clicks mientras anima

function mountReino(){
  sceneName = "reino";
  document.getElementById("sceneLabel").innerText = "Reino M√°gico";
  disposeScene(currentScene);
  currentScene = new THREE.Scene();
  currentScene.background = new THREE.Color(0x051024); // deep night-ish

  currentScene.add(new THREE.AmbientLight(0xffffff, 0.45));
  let dir = new THREE.DirectionalLight(0xffffff, 0.5);
  dir.position.set(5,10,7);
  currentScene.add(dir);

  // Sun (emissive sphere)
  let sunGeo = new THREE.SphereGeometry(10, 48, 32);
  let sunMat = new THREE.MeshStandardMaterial({ emissive:0xffb347, emissiveIntensity:1, color:0xff8c42, roughness:0.3, metalness:0.1 });
  let sun = new THREE.Mesh(sunGeo, sunMat);
  sun.position.set(-28, 10, -40);
  sun.userData.type = "sun";
  currentScene.add(sun);
  reinoObjects.sun = sun;

  // Moon
  let moonGeo = new THREE.SphereGeometry(6, 32, 24);
  let moonMat = new THREE.MeshStandardMaterial({ color:0xdfe6ea, roughness:0.9 });
  let moon = new THREE.Mesh(moonGeo, moonMat);
  moon.position.set(28, 12, -30);
  moon.userData.type = "moon";
  currentScene.add(moon);
  reinoObjects.moon = moon;

  // Earth (world)
  let earthGeo = new THREE.SphereGeometry(9, 48, 32);
  let earthMat = new THREE.MeshStandardMaterial({ color:0x2a6f97, roughness:0.7 });
  let earth = new THREE.Mesh(earthGeo, earthMat);
  earth.position.set(0, -8, -20);
  earth.userData.type = "earth";
  currentScene.add(earth);
  reinoObjects.earth = earth;

  // small orbiting cloud (visual)
  let cloudGeo = new THREE.TorusGeometry(12, 0.6, 16, 64);
  let cloudMat = new THREE.MeshStandardMaterial({ color:0xffffff, opacity:0.08, transparent:true });
  let cloud = new THREE.Mesh(cloudGeo, cloudMat);
  cloud.position.copy(earth.position);
  currentScene.add(cloud);

  // lake & fishes (hidden until earth click)
  let lakeGeo = new THREE.CircleGeometry(12, 64);
  let lakeMat = new THREE.MeshBasicMaterial({ color:0x084b7a, side:THREE.DoubleSide });
  let lake = new THREE.Mesh(lakeGeo, lakeMat);
  lake.rotation.x = -Math.PI/2;
  lake.position.set(0,-9.5, -18);
  lake.visible = false;
  currentScene.add(lake);
  reinoObjects.lakePlane = lake;

  // fish group
  let fishGroup = new THREE.Group();
  for(let i=0;i<8;i++){
    let fGeo = new THREE.SphereGeometry(0.6, 8,8);
    let fMat = new THREE.MeshStandardMaterial({ color: (i%2?0xffdd57:0xff6b6b) });
    let fish = new THREE.Mesh(fGeo, fMat);
    fish.position.set(Math.cos(i)*4 + (Math.random()-0.5), -9.2 + Math.random()*0.6, -18 + Math.random()*1);
    fish.userData.phase = Math.random()*Math.PI*2;
    fishGroup.add(fish);
  }
  fishGroup.visible = false;
  currentScene.add(fishGroup);
  reinoObjects.fishGroup = fishGroup;

  // event: raycast clicks
  addClickHandling();
}

/* Raycaster + click handling */
let raycaster = new THREE.Raycaster();
let pointer = new THREE.Vector2();
function addClickHandling(){
  window.addEventListener('pointerdown', onPointerDown);
}

function removeClickHandling(){
  window.removeEventListener('pointerdown', onPointerDown);
}

function onPointerDown(e){
  if (interactionLocked) return;
  pointer.x = (e.clientX / window.innerWidth) * 2 - 1;
  pointer.y = - (e.clientY / window.innerHeight) * 2 + 1;
  raycaster.setFromCamera(pointer, camera);
  let intersects = raycaster.intersectObjects(currentScene.children, true);
  if (intersects.length>0){
    let obj = intersects[0].object;
    // climb the parents to find userData.type
    while(obj && !obj.userData.type) obj = obj.parent;
    if(!obj || !obj.userData.type) return;
    if(obj.userData.type === "sun") {
      approachObject(obj, 8, ()=> {
        showMessage("Eres el sol que ilumina mi mayor oscuridad");
      });
    } else if(obj.userData.type === "moon") {
      approachObject(obj, 8, ()=> {
        showMessage("Eres lo m√°s hermoso de mi sistema solar");
      });
    } else if(obj.userData.type === "earth") {
      approachObject(obj, 12, ()=> {
        // reveal lake & fishes and show "entrar al lago" control
        reinoObjects.lakePlane.visible = true;
        reinoObjects.fishGroup.visible = true;
        showMessage("Has llegado a mi mundo. Presiona 'Entrar al lago' para explorar.");
        showLakeEnter();
      });
    }
  }
}

/* simple camera approach tween to target object */
function approachObject(targetMesh, distanceFromTarget, onNear){
  interactionLocked = true;
  // compute desired camera position: along vector from object to camera normalized * distance + object position
  const targetPos = new THREE.Vector3();
  targetMesh.getWorldPosition(targetPos);

  const dir = new THREE.Vector3().subVectors(camera.position, targetPos).normalize();
  const endPos = new THREE.Vector3().addVectors(targetPos, dir.multiplyScalar(distanceFromTarget));

  const startPos = camera.position.clone();
  const startLook = new THREE.Vector3();
  camera.getWorldDirection(startLook);
  const targetLookAt = targetPos.clone();

  let t = 0;
  const duration = 1.2; // seconds
  const startTime = performance.now();
  function step(now){
    let elapsed = (now - startTime)/1000;
    t = Math.min(1, elapsed / duration);
    // smoothstep
    let s = t * t * (3 - 2*t);
    camera.position.lerpVectors(startPos, endPos, s);
    camera.lookAt( targetLookAt );
    if (t < 1) requestAnimationFrame(step);
    else {
      // near reached
      if (typeof onNear === 'function') onNear();
      // keep camera near, then re-enable after short delay
      setTimeout(()=> { interactionLocked = false; }, 400);
    }
  }
  requestAnimationFrame(step);
}

/* message box helper */
let msgTimer = null;
function showMessage(text, ms=3500){
  const mb = document.getElementById("messageBox");
  mb.innerText = text;
  mb.style.display = "block";
  if(msgTimer) clearTimeout(msgTimer);
  msgTimer = setTimeout(()=> { mb.style.display = "none"; }, ms);
}

/* show lake enter control (in DOM) */
function showLakeEnter(){
  let existing = document.getElementById("lakeNextBtn");
  if(existing) return;
  const btn = document.createElement("button");
  btn.id = "lakeNextBtn";
  btn.textContent = "Entrar al lago üêü";
  btn.className = "smallBtn";
  btn.style.position = "fixed";
  btn.style.left = "50%";
  btn.style.transform = "translateX(-50%)";
  btn.style.bottom = "40px";
  btn.style.zIndex = 90;
  document.body.appendChild(btn);
  btn.onclick = ()=> {
    // simulate teleport inside lake (closer camera and show fishes animation more)
    camera.position.set(0, -6, -6);
    camera.lookAt(new THREE.Vector3(0,-9.5,-18));
    showMessage("Bienvenido al lago üåä",2500);
    // reveal next scene button
    document.getElementById("nextSceneBtn").style.display = "inline-block";
    btn.remove();
  };
}

/* =====================================================
   RENDER LOOP (one renderer for all scenes)
   ===================================================== */
function update(delta){
  // small camera drift controlled by mouse when not locked
  if(!interactionLocked){
    camera.rotation.y += (mouse.x * 0.002) * delta * 60;
    camera.rotation.x += (mouse.y * 0.001) * delta * 60;
  }

  // galaxy anims
  if(sceneName === "galaxia" && galaxyObjects.stars){
    galaxyObjects.stars.rotation.y += 0.0003 * delta * 60;
    galaxyObjects.photos?.forEach((p,i)=> {
      p.rotation.y += 0.001 * delta * 60;
    });
  }

  // reino anims
  if(sceneName === "reino"){
    if(reinoObjects.sun) reinoObjects.sun.rotation.y += 0.002 * delta * 60;
    if(reinoObjects.moon) reinoObjects.moon.rotation.y += 0.0015 * delta * 60;
    if(reinoObjects.earth) reinoObjects.earth.rotation.y += 0.0018 * delta * 60;

    // fishes swim
    if(reinoObjects.fishGroup && reinoObjects.fishGroup.visible){
      reinoObjects.fishGroup.children.forEach((f, idx)=>{
        f.userData.phase += 0.02 * delta * 60;
        f.position.x = Math.cos(f.userData.phase + idx) * (3 + Math.sin(f.userData.phase*0.6));
        f.position.z = -18 + Math.sin(f.userData.phase*0.7) * 0.8;
      });
    }
  }
}

function animateLoop(){
  const dt = clock.getDelta();
  update(dt);
  renderer.render(currentScene, camera);
  requestAnimationFrame(animateLoop);
}

/* =====================================================
   Scene switching controls
   ===================================================== */
document.getElementById("toGalaxy").onclick = () => {
  // remove lakeNext if any, hide next button
  document.getElementById("nextSceneBtn").style.display = "none";
  const ln = document.getElementById("lakeNextBtn");
  ln?.remove();
  mountGalaxy();
};
document.getElementById("toScene3").onclick = () => {
  mountReino();
  document.getElementById("nextSceneBtn").style.display = "none";
  const ln = document.getElementById("lakeNextBtn");
  ln?.remove();
};

/* next scene button (go to future escena4: for now just a placeholder) */
document.getElementById("nextSceneBtn").onclick = ()=> {
  alert("Aqui ir√≠a la siguiente escena (Escena 4). La implementamos si quieres üôÇ");
};

/* responsive */
window.addEventListener("resize", ()=>{
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

/* initial mount & start loop */
mountGalaxy(); // arranca en galaxia
animateLoop();

/* show initial short hint */
setTimeout(()=> showMessage("Haz clic en Sol, Luna o Mundo para acercarte", 3500), 900);
</script>
</body>
</html>
